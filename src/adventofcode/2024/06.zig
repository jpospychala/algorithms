const std = @import("std");

const MoveError = error{EndOfMap};

const State = struct {
    map: []const u8,
    width: usize,
    height: usize,
    x: isize,
    y: isize,
    dx: i8,
    dy: i8,
    distinctPositions: std.ArrayList(usize),

    fn init(input: []const u8, a: std.mem.Allocator) !State {
        const width = std.mem.indexOfScalar(u8, input, '\n').?;
        const height = input.len / (width + 1);
        const idx = std.mem.indexOfAny(u8, input, "<>^v").?;
        const y: isize = @intCast(@divFloor(idx, width + 1));
        const x: isize = @intCast(@mod(idx, width + 1));
        const dx: i8 = @as(i8, @intCast(std.mem.indexOfScalar(u8, "< >", input[idx]) orelse 1)) - 1;
        const dy: i8 = @as(i8, @intCast(std.mem.indexOfScalar(u8, "^ v", input[idx]) orelse 1)) - 1;
        var distinctPositions = std.ArrayList(usize).init(a);
        try distinctPositions.append(idx);

        return .{
            .map = input,
            .width = width,
            .height = height,
            .x = x,
            .y = y,
            .dx = dx,
            .dy = dy,
            .distinctPositions = distinctPositions,
        };
    }

    fn deinit(state: *State) void {
        state.distinctPositions.deinit();
    }

    fn run(state: *State) !void {
        while (true) {
            state.move() catch {
                return;
            };
            const idx = state.idxOf(state.x, state.y);
            _ = std.mem.indexOfScalar(usize, state.distinctPositions.items, idx) orelse {
                try state.distinctPositions.append(idx);
            };
            std.debug.print("{d}x{d} {d}\n", .{ state.x, state.y, state.distinctPositions.items.len });
        }
    }

    fn move(state: *State) MoveError!void {
        const x = state.x + state.dx;
        const y = state.y + state.dy;

        if (x < 0 or x >= state.width or y < 0 or y >= state.height) {
            return MoveError.EndOfMap;
        }

        const c = state.map[state.idxOf(x, y)];
        if (c == '#') { // obstacle, should turn right
            //dx dy => dx dy
            //-1  0 =>  0 -1
            // 1  0 =>  0  1
            // 0 -1 =>  1  0
            // 0  1 => -1  0
            if (state.dx != 0) {
                state.dy = state.dx;
                state.dx = 0;
            } else {
                state.dx = -state.dy;
                state.dy = 0;
            }
        } else { // can move forward
            state.x = x;
            state.y = y;
        }
    }

    fn idxOf(state: *State, x: isize, y: isize) usize {
        return @as(usize, @intCast(y)) * state.width + @as(usize, @intCast(x));
    }
};

fn task6(input: []const u8, a: std.mem.Allocator) !usize {
    var state = try State.init(input, a);
    defer state.deinit();
    try state.run();

    return state.distinctPositions.items.len;
}

test "task a" {
    const actual = try task6(testInput(), std.testing.allocator);
    try std.testing.expectEqual(41, actual);
}

//test "task a, final input" {
//    const actual = try task6(finalText(), std.testing.allocator);
//    try std.testing.expectEqual(5329, actual);
//}

//test "task b" {
//    const actual = try task5b(testInput(), std.testing.allocator);
//    try std.testing.expectEqual(123, actual);
//}
//
//test "task b, final input" {
//    const actual = try task5b(finalText(), std.testing.allocator);
//    try std.testing.expectEqual(5833, actual);
//}

fn testInput() []const u8 {
    return 
    \\....#.....
    \\.........#
    \\..........
    \\..#.......
    \\.......#..
    \\..........
    \\.#..^.....
    \\........#.
    \\#.........
    \\......#...
    \\
    ;
}

fn finalText() []const u8 {
    return 
    \\...#........................................#........#.................#............#.#.......................#...............#..#
    \\...#........#.....#..................................................................................#......#..#..................
    \\.................#.......................#.#........#......#...........................................#...#..........#...........
    \\..................#..................#...#.....................................#........#.........................................
    \\...#.....#.......#..............#.#....##.............#....##......................................#...................#..........
    \\...#..........................................................................................................................#...
    \\..#..#.............#.....#...............#.......#..............................................#....#............................
    \\......................#..#...............#...................#....#..........................#...#............#...#....##.........
    \\..#.#.........#................#............#............#.#.......#................#....#..#.....................................
    \\.......................................................................#.....................................#...........#........
    \\...........#.....................................................................#.................................#......#.......
    \\...#.........#....................................................#..............#.............#..........#.......................
    \\.................................................................................................#................................
    \\..................................#.#.#...#.......#.............#.......................#..#.......................#.#............
    \\.......................#.........................................#..........#...#.....#....................................#......
    \\.......#.......#.#...........#......................#.....#..#...#.#...............#.............................#...#............
    \\............##...#......#.........#......#............................................................#.........#..............#..
    \\..#........................................#........##..#...............................................................#.........
    \\...........#..............##................................................................................#.....................
    \\..#................................................................................#..............#...............................
    \\...................................##..............#..........................#.......#..#...............#........#...............
    \\....#............#.........................#................................................................#........#............
    \\............#.....................................................................#.............................................#.
    \\............#..........#.......#...........#.#......#..............#.........#.......................................#......#.....
    \\..#...............................................#..................................#.............................#.............#
    \\.........................................................................#........#................#......#.......#....#........#.
    \\.......................................................................#.....##.................................................#.
    \\..............#.............#...........................#...#..#....................................................#.............
    \\.......#..........................#.......................###..................................#.....................#..#.........
    \\................#.................#.............#......................................................................#........#.
    \\.#.....#................#......................................................................#................#.................
    \\................................#........................#........#..#........................#...................................
    \\..............................................................................................#.....................#.........#...
    \\..................#.................#.........................#.....#................#............................................
    \\......#...................#...#...................#..................#...........................#......###...................#...
    \\.............................##.....#..............#..............................................................#....#..........
    \\......#..................#....................................................###....................#..............#.............
    \\............#...#..................#........#.............#..............................#.........#..........................#...
    \\....#...............................#......#......#...............#.#......#............#...................................#.....
    \\.......#...................................#.#.#.........................................................#..................#.....
    \\.....................#.......#.#......#.#.....................#...................................................................
    \\......#.....#............................................................................#............#.......#..#................
    \\..........#.#......#...................................#....#.#............##.....................................................
    \\...............#........................#..................................#...........#...................................#......
    \\.#....................................................#.......................................................................#...
    \\......#.........................................#...#.........................................#........#..........................
    \\.........................................#..........#.............................................................................
    \\...................#.....................................#.....................#..#............#....#........................##...
    \\.................................#.........#.............#.............................#...........................#...#..........
    \\..#................................................................#.....#....#.................................#.................
    \\........#................#............#.#..........................................#..............................................
    \\..#...........##.....................#..#..........................#...#...#....#.................................................
    \\................................................................................#.................................................
    \\............#...........#.........#....#.........................................................................#................
    \\.............................#...........................................#...............##...................................#...
    \\......................#..............#...#........................#........................................#......................
    \\............#..............#...#.....#.....#..........#...........................#........#...............#......................
    \\..................#............................#....#................................................................#............
    \\..#........................#.............................#......#...............#....#...........#................................
    \\.................................................#................................................#..................#........#...
    \\.#......#.........................................................#...........#...#.......................#.......................
    \\..........................................#.......##........#................................................#..##............##..
    \\..............#...#....................................................................#........#...........................#.....
    \\................#....................................................................#........................................###.
    \\....#............................................#........................#.................#........#.....#...#.....#.#....#.....
    \\...##..........#..................................................................................................................
    \\#....#.........#....................#.#.........................#..........##.......#....#..#....................#................
    \\........#.........#..........#.................#..................#................................#.......#................#...#.
    \\.#..........................................#..#..#......#................................#.#.#..#................................
    \\....#.......#.........#............................................................#....#.........................................
    \\.....................................................................#...#......................#.................................
    \\............#.....#.....#..........#...............................................................................#..............
    \\.........................#...#.#.......#....................................................................#.................#...
    \\......................................................#.#..........................#...#................#.........................
    \\.....#.........#.........#..............................................................#...................#.#......#............
    \\.......................................#......#.......................#.................................................#.....#...
    \\.....#....#.......................................................................................................................
    \\#..........#....#....................................#.............#...............#...................#..........#...............
    \\..#....................................##.....................................#...............................#...................
    \\....#..................................#........................#.................................................................
    \\....#................................................................................................#...................#........
    \\....#................................................................................#............................................
    \\..........#.....#...................#.......................#......#..............................................................
    \\#...................#..........#............................................................#............#..............#.........
    \\...#...#....#................................#............................#.##.....................................#..............
    \\..........#.........#.....#...........#............................#...............#.#....#................#....................##
    \\.....#...................................................#........................................................................
    \\............##....................................#..................#.#..#.....................#.........#....##......#...#......
    \\...........#.......#....................#.......................#..#.................#.......#.........#..........................
    \\#.....................#..#..............................................................................................#.........
    \\....#....#..............#............##....................................................^.................#..............#.....
    \\.........#......................................................#..............#............#...#......#....#.....................
    \\.......##...................#...........#.........#.......................................#..........................#............
    \\.#........#.#........................#...........#............#..#........#........#.............#................................
    \\..................##........##.................................................................................#................#.
    \\...#...................#.....#...........#.........#..#............#..................................#.....#.....................
    \\.................#.........#..........#............#......#.........................#.............#.......#......................#
    \\.................................................................#...............#.....#.#....#...................................
    \\..........................#...........................................................................................#..#........
    \\..............#.................................................................................##......................#.........
    \\....#...#....................#...............................................#................#............#......................
    \\........................................................................#........#................................................
    \\....#.....#......................#.......#............#......................................#..................................#.
    \\................#................................#.#.............#.#.........#..............................................#.....
    \\..............#..................#...#...........................................................................#................
    \\...#..........#....................................................#...............................#...........#.......#..........
    \\...................................#....................#..#.#........#..#.......................#...#.....#......................
    \\.......#.....#.#.......#....#............#...............#..........#.................#........#.#................................
    \\.....#....#.........#........#.......#............................................................................................
    \\..#........#......#............................................................#..........#...............................#.......
    \\..#..#...................................#....................#...#.#................#......................#.....................
    \\....................................#......#.....................#...........#.....................#........#.....................
    \\.#..................#.........................................................................................................#...
    \\..............#...........#.#....#..#......#..#.#...#.#.........................................................................#.
    \\...#............##.......................................................#.......................#..#.............................
    \\......#........#..........#..#.#........#.....................#...................................................................
    \\...#...........#.........................................#............#.............#....#.....................................#..
    \\...........#.....................#......................................................................................#.........
    \\.......#..............#...............#............#..........................#............................#........##............
    \\.............#..........#..............................................#................#..............................#..........
    \\...............#..............................#.................#.....#................#....#.....................................
    \\............#.................#..........#........#............#..#......#.......................#....#...#.#...#.#...............
    \\.......#.#...................................##..............#.....#.....................#.................................##.....
    \\..#..#...#...#....#.............#..#.....................................................................................#........
    \\......#......................#...#...#..........#......................................#.................#....#.................#.
    \\.......#...........#...........#...................#..............................#.......................................#.......
    \\......#.......................................#...............................................#.........#........#....#.........##
    \\......#.................................................................#...#............#..........#.............................
    \\.....................................#..........#.........#.....#.............#...........#.......................................
    \\.#.....................................#......................#.....#..#..........................................................
    \\
    ;
}
